# 自用运维面试题

作者：C_Joe

请善用 Ctrl + F 或查找功能，对内容进行快速定位。

[TOC]

## 资料参考链接

1. [OSI 7层模型和TCP/IP 4层模型 - 知乎 (zhihu.com)](https://zhuanlan.zhihu.com/p/32059190)
2. [两张动图-彻底明白TCP的三次握手与四次挥手_三次握手和四次挥手_小书go的博客-CSDN博客](https://blog.csdn.net/qzcsu/article/details/72861891)
3. [云计算的三种服务模式：IaaS，PaaS和SaaS - 知乎 (zhihu.com)](https://zhuanlan.zhihu.com/p/28532380)
4. [C-Joe1/learn-by-myself: C_Joe的自学笔记 (github.com)](https://github.com/C-Joe1/learn-by-myself)
5. [nginx负载均衡的五种算法_nginx负载均衡算法_皓阳当空的博客-CSDN博客](https://blog.csdn.net/apple9005/article/details/79961391)
6. [Nginx面试题（总结最全面的面试题！！！） - 掘金 (juejin.cn)](https://juejin.cn/post/6844904125784653837#heading-4)
7. [彻底搞懂 MySQL 事务的隔离级别-阿里云开发者社区 (aliyun.com)](https://developer.aliyun.com/article/743691)
8. [四个案例看懂 MySQL 事务隔离级别-mysql四种事务隔离级别 (51cto.com)](https://www.51cto.com/article/679914.html)
9. [MySQL 事务的四大特性以及隔离级别 | Laravel China 社区 (learnku.com)](https://learnku.com/articles/45573)
10. [面试必问的 MySQL，你懂了吗？ - 知乎 (zhihu.com)](https://www.zhihu.com/question/584739919)
11. [主数据库宕机怎么办？MHA高可用帮你实现主从服务器自动切换（详细操作与命令详解）_数据库服务器崩溃自动切换_小肥是只猫的博客-CSDN博客](https://blog.csdn.net/qq_41786285/article/details/109375970)
12. [MYSQL高可用架构之MHA实战三 mha+keepalive_ZeroMaster的博客-CSDN博客](https://blog.csdn.net/wszhm123/article/details/126784759)
13. [MHA master_ip_failover脚本文件,自用亲测，无坑_ 清欢渡.的博客-CSDN博客](https://blog.csdn.net/shm19990131/article/details/107423239)
14. [Linux实战教学笔记40： Mha-Atlas-MySQL高可用方案实践(二) - 无情站长 - 博客园 (cnblogs.com)](https://www.cnblogs.com/skyhu365/p/10652830.html#_label2_0)

## 网络基础

### OSI 模型

#### **七层模型**

应用层 => 表示层 => 会话层 => 传输层 => 网络层 => 数据链路层 => 物理层

#### **四层模型**

（			  应用层		 	  ）=> 传输层 => 网络层 => （  	数据链路层  	）

#### 模型讲解

1. **应用层**：为应用程序提供网络接口；

2. **表示层**：将数据格式化转换，进行加密、解密、压缩；

3. **会话层**：用于建立、维护及管理会话连接；

4. **传输层**：用于建立、维护及管理端到端连接（报文传输与差错控制）；

5. **网络层**：提供路由寻址（IP 协议），将上层分段的数据打包，从源端传输到目标端（网络互联）；

6. **数据链路层**：将数据包封装为 MAC 帧，提供节点到节点的数据传输，控制网络层与物理层之间的通信；
   1. MAC 帧分为两部分：
      1. Head：标明数据发送者、接收者、数据类型；
      2. Data：实际数据内容。
   
   2. 通过 MAC 地址（网卡地址）定位数据包路径：
   
7. **物理层**：在介质中传输比特流数据，提供底层的链路介质规范。
   1. 通过光缆、电缆、无线电波等方式将设备连接起来组网；
   2. 两个不同局域网（移动、电信）通信，需要ISP互联网服务供应商的物理连接。

![1](https://note-1308251438.cos.ap-guangzhou.myqcloud.com/typora/202208191147064.gif)

### TCP 三次握手四次挥手（数据传输原理）

1. 三次握手：

   1. 客户端发送请求报文到服务端，表示需要建立 TCP 连接；

   2. 服务端将回复此请求报文到客户端，表示已收到建立 TCP 连接请求；

   3. 客户端在收到回复后，会再次回复请求报文到服务端，表示已收到回复，确定两端收发包正常，开始传输数据。

![image.png](https://s2.loli.net/2023/06/29/GjOE3BiNTSqVhWf.png)

2. 四次挥手：

   1. 客户端发送结束请求到服务端，表示需要结束 TCP 连接，

      此时客户端进入半关闭状态 Fin-wait1 ，客户端将不再发送数据，仅接收数据；

   2. 服务端将回复此请求，向客户端确定已收到结束请求，

      客户端收到确定信息回复后，进入等待状态 Fin-wait2 ；

   3. 待服务端传输数据完毕后，将向客户端发送结束请求，表示数据传输完毕，需结束 TCP 连接，

      此时服务端进入最后确认状态 Last-ACK ，等待客户端确认；

   4. 客户端将回复此请求，向服务端确认已收到结束请求，进入最终等待状态 Time-Wait ，

      客户端将在 2*<font color=red>MSL</font>（最长报文段寿命）后，进入结束状态 Closed ，不再收发数据，

      服务端收到确认信息后，进入结束状态 Closed ，不再收发数据。

![image.png](https://s2.loli.net/2023/06/29/gbMcZdkX7fmTPC8.png)

**关于 MSL **

用于保证第四次挥手时，客户端可以在 Time-Wait 时收到因确认信息丢失而导致服务端重发的结束请求，并重新进行第四次挥手。

MSL 并无固定值，TCP 协议允许不同的实现可以设置不同的 MSL 值。

## 云计算服务模式

**IaaS，PaaS 和 SaaS**

1. **IaaS : Infrastructure-as-a-Service（基础设施即服务）**

   将硬件外包到 IaaS 公司，IaaS 公司会提供云服务器，存储和网络硬件，你可以租用。节省了维护成本和办公场地，公司可以在任何时候利用这些硬件来运行其应用。

2. **PaaS : Platform-as-a-Service（平台即服务）**

   将一个开发平台作为服务提供给用户，PaaS 公司在网上提供各种开发和分发应用的解决方案，比如虚拟服务器和操作系统。这节省了你在硬件上的费用，让工作室之间的合作变得更加容易。网页应用管理，应用设计，应用虚拟主机，存储，安全以及应用开发协作工具等。

3. **SaaS: Software-as-a-Service（软件即服务）**

   将应用作为服务提供给客户，通过网页浏览器来接入，任何一个远程服务器上的应用都可以通过网络来运行。

## SQL 语句

SQL Mind Map

[learn-by-myself/SQL/SQL.png at main · C-Joe1/learn-by-myself · GitHub](https://github.com/C-Joe1/learn-by-myself/blob/main/SQL/SQL.png)

## Nginx

### Nginx 是什么

Nginx 是一个轻量级/高性能的反向代理 Web 服务器，同时也是一个比较优秀的负载均衡服务器和缓存服务器，它能实现非常高效的反向代理、负载平衡，它可以处理 2-3 万并发连接数，官方监测能支持 5 万并发，现在中国使用 nginx 网站用户有很多，例如：新浪、网易、 腾讯等。

### 为什么用 Nginx

跨平台、配置简单；

反向代理：可以不暴露正式的服务器IP地址；

高并发连接：处理2-3万并发连接数，官方监测能支持5万并发；

内存消耗小：开启10个nginx才占150M内存 ，nginx处理静态文件好，耗费内存少。

### Nginx 有高性能的原因

因为它的事件处理机制：异步非阻塞事件处理机制，运用了 epoll 模型，提供了一个队列，排队解决。

### Nginx的缺点

动态处理差，需要配合Tomcat进行动静分离处理。

### 动静分离怎么实现（思路）

对于静态资源比如图片，js，css等文件，我们则在反向代理服务器nginx中进行缓存，

这样浏览器在请求一个静态资源时，代理服务器nginx就可以直接处理，无需将请求转发给后端服务器tomcat；

若用户请求的动态文件，比如servlet,jsp则反向代理转发给Tomcat服务器处理，从而实现动静分离。

### Nginx 怎么处理请求

nginx接收一个请求后，首先由listen和server_name指令匹配server模块，再匹配server模块里的location，location就是实际地址。

```
server {            		    			# 第一个Server区块开始，表示一个独立的虚拟主机站点
    listen       80;      		        	# 提供服务的端口，默认80
    server_name  localhost;    				# 提供服务的域名主机名
    location / {							# 第一个location区块开始
        root   html;       					# 站点的根目录，相当于Nginx的安装目录
        index  index.html index.htm;		# 默认的首页文件，多个用空格分开
    }										# 第一个location区块结果
}       
```

### 什么是正向代理和反向代理

1. 正向代理就是一个人发送一个请求直接就到达了目标的服务器；
2. 反方代理就是请求统一被 Nginx 接收，nginx 反向代理服务器接收到之后，按照一定的规则分发给了后端的业务处理服务器进行处理了。

### 负载均衡算法

1. **轮询（默认）**
   每个请求按时间顺序依次分配到不同的后端服务器，

   后端服务器宕机时，能被自动剔除，且请求响应情况不会受到任何影响；

2. **轮询权值**（weight）
   指定轮询概率，权重和访问比率成正比，用于后端服务器性能不均的情况，

   权重越高，被访问的概率就越大，常用于服务上线发布场景；

3. **基于IP地址计算的哈希值分配**（ip_hash）
   每个请求按访问IP生成的hash结果分配，会让相同客户端IP请求相同的服务器，

   可以有效解决动态网页存在的session共享问题；

4. **基于URL地址计算的哈希值分配**（url_hash）
   根据访问的URL计算出的hash结果来分配请求，每个请求的URL会指向后端某个固定的服务器，

   通常用在nginx作为静态资源（缓存）服务器的场景，可以提高缓存效率，
   但是nginx服务默认不支持该算法，如需要使用，要安装hash软件包；

5. **智能分配**（fair）
   通过智能识别后端服务器处理请求的响应时间来进行负载分配，响应时间短的优先分配，
   但是nginx服务默认不支持该算法，如需要使用，要安装upstream_fair模块；

## MySQL

### 简述一下事务的几种特性

***简称 ACID，缺一不可。***

- **原子性（Atomicity）**

   一个事务中的所有操作，要么全部完成，要么全部不完成，不会结束在中间某个环节。

  事务在执行过程中发生错误，会被回滚到事务开始前的状态，就像这个事务从来没有执行过一样。

- **一致性（Consistency）**

  在事务开始之前和事务结束以后，数据库的完整性没有被破坏。

  这表示写入的数据必须完全符合所有的预设规则，这包含数据的精确度、串联性以及后续数据库可以自发性地完成预定的工作。

- **隔离性（Isolation）**

  数据库允许多个并发事务同时对其数据进行读写和修改的能力，隔离性可以防止多个事务并发执行时由于交叉执行而导致数据的不一致。

- **持久性（Durability）**

  事务处理结束后，对数据的修改就是永久的，即便系统故障也不会丢失。

### 事务的隔离级别有哪些

隔离级别：用于在多个事务并发时进行事务隔离。

- **读未提交** (RU) READ UNCOMMITTED

  ***提供了事务之间最小限度的隔离。***

  - 容易出现脏读、幻读或不可重复读
  - 会读到其他事务未提交的数据

- **读已提交** (RC) READ COMMITT

  ***安全性比可重复读要低***

  - 不会出现脏读，但仍可能出现幻读或不可重复读
  - 会读到其他事务已提交的数据

- **可重复读** (RR) REPEATABLE READ

  ***MySQL的默认隔离级别***

  - 不会出现脏读、不可重复读，但仍可能出现幻读
  - 当前事务只能在其他事务已提交数据，且当前事务同样提交数据后，才能读取到数据

- **串行化** SERIALIZABLE

  ***性能最差的隔离级别***

  - 不会出现脏读、幻读以及不可重复读
  - 在上一个事务完成提交之前，其他事务无法进行操作

随着隔离级别的上调，事务性能会变得越来越差。

#### 知识补充

- **脏读**
  - 指当前事务读到了其他事务**未提交**的数据。
  - 未提交意味着这些数据可能会回滚，也就是可能最终不会存到数据库中，也就是不存在的数据。
  - 读到了并不一定最终存在的数据，这就是脏读。

- **可重复读**
  - 指在一个事务内，最开始读到的数据和事务结束前的任意时刻读到的同一批数据都是一致的。
  - 通常针对数据更新（UPDATE）操作。

- **不可重复读**
  - 指在同一事务内，不同的时刻读到的同一批数据可能是不一样的，可能会受到其他事务的影响，比如其他事务改了这批数据并提交了。
  - 通常针对数据更新（UPDATE）操作。

- **幻读**
  - 指当前事务修改数据后，被其他事务插入了与当前事务修改前相同的数据，并且其他事务比当前事务更快地提交了，造成当前事务无法查询到刚刚修改的数据。
  - 就像出现了幻觉一样，这就叫幻读。
  - 通常针对数据插入（INSERT）操作。

### 几种日志的作用

1. **错误日志（error log）**

   记录出错信息，也记录一些警告信息或者正确的信息。

2. **查询日志（general log）**

   记录所有对数据库请求的信息，不论这些请求是否得到了正确的执行。

3. **慢查询日志（slow query log）**

   设置一个阈值，将运行时间超过该值的所有SQL语句都记录到慢查询的日志文件中。

4. **二进制日志（binlog）**

   记录对数据库执行更改的所有操作。

5. **中继日志（relay log）**

   中继日志也是二进制日志，用来给从库恢复。

6. **重做日志（redo log）**

   确保事务的持久性，防止在发生故障的时间点，尚有脏页未写入磁盘，在重启mysql服务的时候，根据redo log进行重做，从而达到事务的持久性这一特性。

7. **回滚日志（undo log）**

   保存了事务发生之前的数据的一个版本，可以用于回滚，同时可以提供多版本并发控制下的读（MVCC），也即可重复读。

### 主从架构的工作原理

整体上来说，复制有 3 个步骤： 

1. 主库将修改语句（ DDL、DCL、DML ）操作记录到二进制日志 bin log 中；
2. 从库将主库的 bin log 通过 I/O 线程拷贝到它的中继日志 relay log ；
3. 从库通过 SQL 线程重做中继日志中的事件（操作），修改从机上的数据。

![file://c:\users\admini~1\appdata\local\temp\tmpodtugz\1.png](https://figure-bed-1304788733.cos.ap-guangzhou.myqcloud.com/typora/202203031928916.png)

### 物理备份与逻辑备份的优缺点

- 物理备份：

  - 通过备份数据文件、控制文件、日志文件及服务器系统文件，把所有数据文件直接备到一个文件集合中。
  - 优点是备份速度快，恢复速度也很快，还能减少备份时出现脏数据的情况。
  - 缺点是需要占用大量磁盘空间，而且不能用于表级别的恢复。

- 逻辑备份：
  - 通过SQL命令将数据库中的“数据库对象（如表、索引、视图等）、用户数据和数据库参数”导出到文件中并进行备份，通常用于备份特定的对象或部分数据的情况下。
  - 优点是灵活性高，对于表级别、对象的备份和恢复非常方便。
  - 缺点是备份和恢复速度相对物理备份要慢一些，且数据类型、字符集等可能存在转换问题。
  - 在恢复逻辑备份的数据时，需要先建立好相对应的数据库结构，对全数据库恢复而言较为繁琐。

![image.png](https://s2.loli.net/2023/06/29/YgkX1Tudof2UeyS.png)

### 怎么用 XtraBackup 备份与恢复

1. **全量备份**

   ```shell
   innobackupex --defaults-file=/etc/my.cnf --socket=/var/lib/mysql/mysql.sock --user=root --password=123456 [bak_dir]
   ```

   该操作会在指定目录下生成一个名为当时备份操作时间的文件夹，备份好的数据都在其中；

2. **全量恢复**

   首先要停止服务；

   ```shell
   systemctl stop mysqld
   ```

   然后重做事务日志；

   ```shell
   innobackupex --apply-log [bak_dir] 
   ```

   接着恢复备份；

   ```shell
   innobackupex --defaults-file=/etc/my.cnf --copy-back
   ```

   最终重新启动服务即可。

   ```shell
   systemctl start mysqld
   ```

3. **增量备份**

   在全量备份的基础上进行增量操作。

   ```shell
   innobackupex --defaults-file=/etc/my.cnf --host=127.0.0.1 --user=root  --password=123456 --incremental --incremental-basedir=[bak_dir] [incre_dir]
   ```

4. **增量恢复**

   首先要停止服务；

   ```shell
   systemctl stop mysqld
   ```

   然后执行全量备份回滚操作；

   ```shell
   innobackupex --apply-log --redo-only [bak_dir]
   ```

   接着执行增量备份到全量备份回滚操作；

   ```shell
   # --redo-only 选项仅在回滚最新的增量备份时可去除
   innobackupex --apply-log [bak_dir] --incremental-dir=[incre_dir]
   ```

   然后执行增量备份恢复。

   ```shell
   innobackupex --defaults-file=/etc/my.cnf --copy-back [bak_dir]
   ```

   最终重新启动服务即可。

   ```shell
   systemctl start mysqld
   ```

### 简单介绍下MHA高可用架构

MHA 是 MySQL 的高可用解决方案之中的一种，能做到在<font color=red> **0 ~ 30** </font>秒之内，自动完成数据库的故障切换操作，并且在进行故障切换的过程中，MHA 能在最大程度上保证数据的一致性，以达到真正意义上的高可用。

### 讲解一下MHA的架构

MHA 主要支持一主多从的架构，它要求一个复制集群中，最少有三台数据库服务器，用于搭建一主两从架构，即一台充当主库，一台从机充当备用主库，另外一台充当从库。

MHA 支持所有存储引擎，只要能主从复制的存储引擎它都支持。

MHA 由两部分组成：

1. MHA Manager （管理节点）
   - MHA Manager 能单独部署在一台独立机器上管理多个主从集群，也能部署在一台从库节点上。
   - 用于检测主库是否宕机。
   - 管理 MHA 服务，如启停、检查状态。
   - 手工转移故障。
   - 检查 MySQL 复制状况。

2. MHA Node （数据节点）
   - MHA Node 运行在每台 MySQL 服务器上。
   - 当主库出现故障时，它可以自动将"最新数据的从库"提升为新的主库，然后将所有其他从库重新指向新的主库。

整个故障转移过程对应用程序完全透明。

![file://c:\users\admini~1\appdata\local\temp\tmpl4ezg9\1.png](https://figure-bed-1304788733.cos.ap-guangzhou.myqcloud.com/typora/202203071920725.png)

### 讲讲MHA的工作原理

MHA 工作原理总结为如下：

1. 从宕机崩溃的主库保存二进制日志事件（binlog events）(数据节点操作)
2. 识别含有最新更新的从库；
3. 应用差异的中继日志（relay log）到其他的从库；
4. 应用从主库保存的二进制日志事件（binlog events）（管理节点操作）
5. 提升一个从库为新的主库；
6. 使其他的从库连接新的主库进行复制。

### 在MHA下如何保证连接稳定

使用自带脚本 master_ip_failover 或 keepalived 。

生产一般用前者。

### MHA有没有什么缺点

只要宕机过一次，就会结束 MHA 后台进程，需要重新配好宕机的机器与其他机器的主从关系，然后在管理节点的 MHA 配置文件添加宕机的信息，再回去重新运行 MHA 。

### 简单介绍一下Atlas是什么

Atlas 是一个基于 MySQL 协议开发的数据中间件，主要可以用于实现 MySQL 的读写分离，目前有超过**<font color=red> 50 </font>**家公司在生产环境中部署了 Atlas 。

Atlas 作为服务端与应用程序通讯，它实现了MySQL的客户端和服务端协议，同时作为客户端与MySQL通讯。

在后端数据库看来，Atlas 相当于连接它的客户端；在前端应用看来，Atlas 相当于一个数据库。

#### **Atlas的主要功能**

1. 读写分离；
2. 从库负载均衡；
3. IP过滤；
4. 自动分表；
5. DBA可平滑上下线DB；
6. 自动摘除宕机的DB。

